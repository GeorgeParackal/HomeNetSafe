<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>HomeNetSafe</title>
<style>
  /* ====== Minimal theme ====== */
  *,*::before,*::after{box-sizing:border-box}
  :root{
    --bg:#0b0f14;
    --panel:#0f141b;
    --ink:#e9f6ff;
    --muted:#9fc9db;
    --accent:#00e5ff;
    --line:rgba(0,229,255,.18);
    --matrix:#08f76f;
  }
  html,body{height:100%}
  body{margin:0;background:radial-gradient(1200px 600px at 50% -10%, #07212c, var(--bg) 60%);color:var(--ink);
       font-family: Inter, ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial}

  /* subtle grid */
  body::after{content:"";position:fixed;inset:0;pointer-events:none;opacity:.08;
    background-image:linear-gradient(90deg,var(--line) 1px,transparent 1px),
                     linear-gradient(0deg,var(--line) 1px,transparent 1px);
    background-size:48px 48px}

  .container{max-width:1100px;margin:0 auto;padding:16px}

  /* ====== Top bar ====== */
  .topbar{position:sticky;top:0;z-index:20;background:linear-gradient(180deg,rgba(11,15,20,.9),rgba(11,15,20,.65));backdrop-filter:blur(6px);border-bottom:1px solid var(--line)}
  .row{display:flex;align-items:center;justify-content:space-between;gap:12px}

  /* Small 3D logo (always top-left) */
  .brand{display:flex;align-items:center;gap:10px}
  .cube{
    width:38px;height:38px;border-radius:10px;position:relative;transform-style:preserve-3d;
    background:linear-gradient(135deg,rgba(0,229,255,.18),rgba(17,37,49,.35));
    border:1px solid rgba(0,229,255,.45);box-shadow:0 0 24px rgba(0,229,255,.35), inset 0 0 30px rgba(0,229,255,.15);
    display:grid;place-items:center;color:#032c33;font-weight:900;letter-spacing:.5px;perspective:800px;
    animation:tilt 6s ease-in-out infinite;
  }
  @keyframes tilt{0%{transform:rotateX(12deg) rotateY(-18deg)}50%{transform:rotateX(18deg) rotateY(12deg)}100%{transform:rotateX(12deg) rotateY(-18deg)}}
  .brand h1{margin:0;font-size:16px;font-weight:800}
  .muted{color:var(--muted);font-size:12px}

  /* ====== Tabs (4 only) ====== */
  input[type=radio]{display:none}
  .tabs{margin-top:10px;border:1px solid var(--line);border-radius:12px;padding:6px;background:rgba(6,14,20,.5)}
  .tab-labels{display:grid;grid-template-columns:repeat(4,1fr);gap:6px}
  .tab-label{display:flex;align-items:center;justify-content:center;padding:10px;border-radius:10px;
    font-weight:700;text-transform:uppercase;font-size:12px;color:var(--muted);
    border:1px solid rgba(0,229,255,.12);background:rgba(3,10,16,.5);cursor:pointer}
  .tab-label:hover{border-color:rgba(0,229,255,.3)}
  .panes{margin-top:14px}
  .pane{display:none}

  /* active label */
  #tab-home:checked ~ .tabs .tab-label[for="tab-home"],
  #tab-devices:checked ~ .tabs .tab-label[for="tab-devices"],
  #tab-killswitch:checked ~ .tabs .tab-label[for="tab-killswitch"],
  #tab-settings:checked ~ .tabs .tab-label[for="tab-settings"]{
    color:#eaffff;background:linear-gradient(180deg,rgba(0,229,255,.2),rgba(0,229,255,.06));
    border-color:rgba(0,229,255,.45);box-shadow:0 0 18px rgba(0,229,255,.25), inset 0 0 0 1px rgba(0,229,255,.25)}
  #tab-home:checked ~ .panes #pane-home,
  #tab-devices:checked ~ .panes #pane-devices,
  #tab-killswitch:checked ~ .panes #pane-killswitch,
  #tab-settings:checked ~ .panes #pane-settings{display:block}

  /* ====== Cards / Controls (minimal) ====== */
  .card{background:var(--panel);border:1px solid var(--line);border-radius:12px;padding:16px}

  /* ====== HOME: big centered 3D logo ====== */
  .hero{
    min-height:52vh;display:grid;place-items:center;position:relative;margin-top:8px;
  }
  .logo3d{
    width:240px;height:240px;border-radius:28px;display:grid;place-items:center;cursor:pointer;
    transform-style:preserve-3d;perspective:1200px;
    background:radial-gradient(120% 120% at 30% 30%, rgba(0,229,255,.22), rgba(0,229,255,.06) 40%, rgba(0,0,0,.0) 60%),
               linear-gradient(135deg, rgba(0,229,255,.18), rgba(17,37,49,.35));
    border:1px solid rgba(0,229,255,.45);
    box-shadow:
      0 0 36px rgba(0,229,255,.35),
      inset 0 0 60px rgba(0,229,255,.15),
      inset 0 0 0 2px rgba(0,229,255,.15);
    animation:float 7s ease-in-out infinite;
    transition:transform .2s ease, box-shadow .2s ease;
  }
  .logo3d:active{transform:scale(.98)}
  @keyframes float{0%{transform:rotateX(14deg) rotateY(-18deg) translateZ(0)}
                   50%{transform:rotateX(18deg) rotateY(14deg) translateZ(10px)}
                   100%{transform:rotateX(14deg) rotateY(-18deg) translateZ(0)}}

  .logo-text{
    font-weight:900;font-size:28px;letter-spacing:.6px;color:#eaffff;text-shadow:
      0 0 18px rgba(0,229,255,.45), 0 0 42px rgba(0,229,255,.25);
    transform:translateZ(30px);
  }
  .hero h2{margin:18px 0 0;font-weight:700;text-align:center;color:var(--muted)}
  .center{display:grid;place-items:center;text-align:center}

  /* layout helpers */
  .grid{display:grid;gap:14px}
  .grid-2{grid-template-columns:repeat(2,minmax(0,1fr))}
  @media (max-width:800px){.grid-2{grid-template-columns:1fr}}

  /* ====== Fullscreen code-rain overlay ====== */
  #matrixOverlay{
    position:fixed;inset:0;background:#000;display:none;z-index:50;
  }
  #matrixCanvas{width:100%;height:100%;display:block}
  #matrixText{
    position:absolute;inset:0;display:grid;place-items:center;z-index:1;
    font-weight:900;letter-spacing:.1em;text-transform:uppercase;
    color:var(--ink);text-shadow:0 0 22px rgba(8,247,111,.75);
    font-size:clamp(28px,6vw,72px);
    opacity:0;transition:opacity .5s ease;
    pointer-events:none;
  }
  #matrixText.show{opacity:1}

  /* ====== Terminal-style output for Scan ====== */
  .terminal{
    background:#061017;
    border:1px solid var(--line);
    border-radius:10px;
    padding:12px;
    color:#b7f5c8;
    font:13px/1.4 ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace;
    max-height:55vh;overflow:auto;white-space:pre-wrap;word-break:break-word;
    box-shadow: inset 0 0 24px rgba(0,229,255,.08);
  }
</style>
</head>
<body>
  <!-- Top bar with small logo on the LEFT -->
  <div class="topbar">
    <div class="container row" style="padding:10px 16px">
      <div class="brand">
        <div class="cube">üõ°Ô∏è</div>
        <div>
          <h1>HomeNetSafe</h1>
          <div class="muted">Simple local network UI</div>
        </div>
      </div>
      <div class="muted">v1 ‚Ä¢ minimal demo</div>
    </div>
  </div>

  <div class="container">
    <!-- Tabs (only 3) -->
  <input type="radio" name="tabs" id="tab-devices" checked>
  <input type="radio" name="tabs" id="tab-killswitch">
  <input type="radio" name="tabs" id="tab-settings">

    <div class="tabs">
      <div class="tab-labels">
        <label class="tab-label" for="tab-devices">Devices</label>
        <label class="tab-label" for="tab-killswitch">Killswitch</label>
        <label class="tab-label" for="tab-settings">Settings</label>
      </div>
    </div>

    <div class="panes">
      <!-- ===== HOME: big centered 3D logo (clickable) ===== -->
            <!-- Device registration modal -->
      <div id="registerModal" style="display:none;position:fixed;top:0;left:0;width:100vw;height:100vh;z-index:101;background:rgba(0,0,0,0.55);">
        <div style="position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);background:var(--panel);border-radius:16px;padding:32px 24px;min-width:320px;max-width:90vw;box-shadow:0 0 32px #0008;">
          <h2 style="margin-top:0;color:var(--accent);font-size:22px;text-align:center;">Register Device</h2>
          <form id="registerForm" style="margin-top:20px;">
            <input type="hidden" id="regDeviceMac">
            <div style="margin-bottom:16px;">
              <label style="display:block;margin-bottom:8px;color:var(--muted);">Custom Name</label>
              <input type="text" id="regDeviceName" style="width:100%;padding:8px;border-radius:8px;border:1px solid var(--line);background:var(--bg);color:var(--ink);" required>
            </div>
            <div style="margin-bottom:16px;">
              <label style="display:block;margin-bottom:8px;color:var(--muted);">Notes</label>
              <textarea id="regDeviceNotes" style="width:100%;padding:8px;border-radius:8px;border:1px solid var(--line);background:var(--bg);color:var(--ink);min-height:80px;"></textarea>
            </div>
            <div style="text-align:center;margin-top:24px;">
              <button type="submit" style="padding:8px 24px;border-radius:8px;background:var(--accent);color:#032c33;font-weight:700;border:none;cursor:pointer;margin-right:12px;">Register</button>
              <button type="button" onclick="document.getElementById('registerModal').style.display='none'" style="padding:8px 24px;border-radius:8px;background:#666;color:var(--ink);font-weight:700;border:none;cursor:pointer;">Cancel</button>
            </div>
          </form>
        </div>
      </div>

      <!-- ===== DEVICES (output of discovered devices) ===== -->
      <section id="pane-devices" class="pane">
        <div class="card">
          <strong>Discovered Devices</strong>
              <div id="scanFailMsg" style="display:none;color:#ff3b3b;font-weight:700;text-align:center;margin:24px 0 18px;font-size:18px;">Scan failed. No devices found.</div>
              <div id="devicesTableWrap" style="overflow:auto;margin-top:10px;">
                <table id="devicesTable" style="width:100%;border-collapse:collapse">
              <colgroup>
                <col style="width:10%"> <!-- Status -->
                <col style="width:15%"> <!-- Name -->
                <col style="width:12%"> <!-- IP -->
                <col style="width:15%"> <!-- MAC -->
                <col style="width:15%"> <!-- Vendor -->
                <col style="width:12%"> <!-- First seen -->
                <col style="width:12%"> <!-- Last seen -->
                <col style="width:9%">  <!-- Action -->
              </colgroup>
              <thead>
                    <tr style="background:rgba(0,229,255,.08);">
                      <th style="text-align:center;padding:12px 8px;font-weight:600;">Status</th>
                      <th style="text-align:left;padding:12px 8px;font-weight:600;">Name</th>
                      <th style="text-align:center;padding:12px 8px;font-weight:600;">IP</th>
                      <th style="text-align:center;padding:12px 8px;font-weight:600;">MAC</th>
                      <th style="text-align:left;padding:12px 8px;font-weight:600;">Vendor</th>
                      <th style="text-align:center;padding:12px 8px;font-weight:600;">First seen</th>
                      <th style="text-align:center;padding:12px 8px;font-weight:600;">Last seen</th>
                      <th style="text-align:center;padding:12px 8px;font-weight:600;">Action</th>
                    </tr>
              </thead>
              <tbody id="devicesBody">
                    <!-- Device rows will be injected here -->
              </tbody>
            </table>
          </div>
        </div>
      </section>

      <!-- ===== KILLSWITCH (placeholder) ===== -->
      <section id="pane-killswitch" class="pane">
        <div class="card center">
          <strong>Killswitch</strong>
          <div class="muted" style="margin-top:10px">This will reset the network in case of failure.<br>Feature coming soon.</div>
        </div>
      </section>

      <!-- ===== SETTINGS (tiny) ===== -->
      <section id="pane-settings" class="pane">
        <div class="grid grid-2">
          <div class="card">
            <strong>Preferences</strong>
            <div style="height:8px"></div>
            <div class="row"><span class="muted">Show tips</span><button class="btn-ghost" onclick="toggle(this)">On</button></div>
            <div class="row" style="margin-top:8px"><span class="muted">Auto-scan new devices</span><button class="btn-ghost" onclick="toggle(this)">Off</button></div>
          </div>
          <div class="card">
            <strong>About</strong>
            <p class="muted" style="margin-top:8px">Static front-end demo. No third-party references. Designed to be clear and simple.</p>
          </div>
        </div>
      </section>
    </div>
  </div>

  <!-- ===== Fullscreen overlay for code rain transition ===== -->
  <!-- ===== Instruction Modal ===== -->
  <div id="instructionModal" style="display:none;position:fixed;top:0;left:0;width:100vw;height:100vh;z-index:101;background:rgba(0,0,0,0.55);">
    <div style="position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);background:var(--panel);border-radius:16px;padding:32px 24px;min-width:320px;max-width:90vw;box-shadow:0 0 32px #0008;">
      <h2 style="margin-top:0;color:var(--accent);font-size:22px;text-align:center;">Instructions</h2>
      <div style="color:var(--ink);font-size:16px;line-height:1.7;margin:18px 0 0;">
        <ul>
          <li>Click the big logo to scan your network for devices.</li>
          <li>View discovered devices in the Devices tab.</li>
          <li>If the scan fails, you will see an error message.</li>
          <li>Use the Killswitch tab to reset your network (coming soon).</li>
          <li>Contact us via email for support or questions.</li>
        </ul>
      </div>
      <div style="text-align:center;margin-top:18px;">
        <button onclick="document.getElementById('instructionModal').style.display='none'" style="padding:8px 24px;border-radius:8px;background:var(--accent);color:#032c33;font-weight:700;border:none;cursor:pointer;">Close</button>
      </div>
    </div>
  </div>
  <!-- ===== Footer ===== -->
  <footer style="width:100%;background:var(--panel);border-top:1px solid var(--line);padding:18px 0 12px;position:fixed;bottom:0;left:0;z-index:99;text-align:center;">
    <div style="margin-bottom:8px;color:var(--muted);font-size:15px;">
      Questions? Contact us at <a href="mailto:support@homenetsafe.com" style="color:var(--accent);text-decoration:none;font-weight:600;">support@homenetsafe.com</a>
    </div>
    <button onclick="document.getElementById('instructionModal').style.display='block'" style="padding:10px 28px;border-radius:10px;background:var(--accent);color:#032c33;font-weight:700;border:none;cursor:pointer;font-size:16px;box-shadow:0 2px 8px #00e5ff22;">Instructions</button>
  </footer>
  <div id="matrixOverlay" aria-hidden="true">
    <canvas id="matrixCanvas"></canvas>
    <div id="matrixText"></div>
  </div>

  <!-- ===== Scan Result Modal ===== -->
  <div id="scanResultModal" style="display:none;position:fixed;top:0;left:0;width:100vw;height:100vh;z-index:100;background:rgba(0,0,0,0.55);">
    <div style="position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);background:var(--panel);border-radius:16px;padding:32px 24px;min-width:320px;max-width:90vw;box-shadow:0 0 32px #0008;">
      <h2 style="margin-top:0;color:var(--accent);font-size:22px;text-align:center;">Scan Result</h2>
      <pre id="scanResultText" style="background:#061017;color:#eaffff;padding:16px;border-radius:10px;max-height:40vh;overflow:auto;font-size:15px;white-space:pre-wrap;word-break:break-word;margin:18px 0 0;text-align:left;"></pre>
      <div style="text-align:center;margin-top:18px;">
        <button onclick="document.getElementById('scanResultModal').style.display='none'" style="padding:8px 24px;border-radius:8px;background:var(--accent);color:#032c33;font-weight:700;border:none;cursor:pointer;">Close</button>
      </div>
    </div>
  </div>

<script>
  // ===== Config
  const API_URL = 'http://127.0.0.1:5000/run-script'; // Flask endpoint

  // ===== Tabs helper
  function switchToDevices(){ document.getElementById('tab-devices').checked = true; }

  // ===== Elements
  const enterScanBtn = document.getElementById('enterScan');
  const overlay = document.getElementById('matrixOverlay');
  const canvas = document.getElementById('matrixCanvas');
  const ctx = canvas.getContext('2d');
  const textEl = document.getElementById('matrixText');
  const scanOutput = document.getElementById('scanOutput');

  let columns = [], drops = [], rafId = null, running = false;
  let pendingOutput = "Waiting for scan...";
  let loadingInterval = null;

  function sizeCanvas(){
    const dpr = Math.max(1, Math.min(2, window.devicePixelRatio || 1));
    canvas.width = Math.floor(canvas.clientWidth * dpr);
    canvas.height = Math.floor(canvas.clientHeight * dpr);
    ctx.setTransform(dpr,0,0,dpr,0,0);
    const columnWidth = 16;
    columns = Math.ceil(canvas.clientWidth / columnWidth);
    drops = new Array(columns).fill(0).map(()=> Math.floor(Math.random()*canvas.clientHeight));
  }

  function drawMatrix(){
    ctx.fillStyle = "rgba(0, 0, 0, 0.08)";
    ctx.fillRect(0, 0, canvas.clientWidth, canvas.clientHeight);

    ctx.font = "16px monospace";
    for(let i=0;i<columns;i++){
      const char = String.fromCharCode(0x30A0 + Math.floor(Math.random()*96));
      const x = i*16;
      const y = drops[i]*16;
      ctx.fillStyle = "rgba(8, 247, 111, 0.9)";
      ctx.fillText(char, x, y);
      if (y > canvas.clientHeight && Math.random() > 0.975) drops[i] = 0;
      drops[i]++;
    }
    if (running) rafId = requestAnimationFrame(drawMatrix);
  }

  function showWord(word, visibleMs = 1000){
    textEl.textContent = word;
    textEl.classList.add('show');
    setTimeout(()=>textEl.classList.remove('show'), visibleMs);
  }

  // ===== Loading pulse logic
  function startLoadingPulse(){
    stopLoadingPulse();
    // First ‚ÄúLoading ‚Ä¶‚Äù shortly after intro words
    setTimeout(()=> showWord('Loading ...'), 3000);
    // Then every 10 seconds
    loadingInterval = setInterval(()=> showWord('Loading ...'), 10000);
  }
  function stopLoadingPulse(){
    if (loadingInterval){
      clearInterval(loadingInterval);
      loadingInterval = null;
    }
  }

  function startTransition(){
    overlay.style.display = 'block';
    sizeCanvas();
    running = true;
    drawMatrix();

    // Sequence: HOME -> NET -> SAFE
    setTimeout(()=>showWord('HOME', 900), 600);
    setTimeout(()=>showWord('NET', 900), 1300);
    setTimeout(()=>showWord('SAFE', 900), 2000);

    // Begin periodic loading pulses after the intro
    startLoadingPulse();
  }

  // ===== localStorage helpers for registered devices
  const REG_KEY = 'homenetsafe_registered_devices_v1';
  function loadRegisteredDevices(){
    try{ const raw = localStorage.getItem(REG_KEY); return raw ? JSON.parse(raw) : {}; }catch{return {};}
  }
  function saveRegisteredDevices(obj){ localStorage.setItem(REG_KEY, JSON.stringify(obj)); }
  function isRegistered(mac){ const map = loadRegisteredDevices(); return !!map[mac]; }
  function registerDevice(dev, customName, notes){ 
    const map = loadRegisteredDevices(); 
    map[dev.mac] = { 
      ...dev, 
      customName: customName,
      notes: notes,
      registeredAt: new Date().toISOString() 
    }; 
    saveRegisteredDevices(map); 
  }
  function unregisterDevice(mac){
    const map = loadRegisteredDevices();
    delete map[mac];
    saveRegisteredDevices(map);
  }

  function renderDevices(devices){
    const tbody = document.getElementById('devicesBody');
    const failMsg = document.getElementById('scanFailMsg');
    const tableWrap = document.getElementById('devicesTableWrap');
    if (!devices || !Array.isArray(devices) || devices.length === 0){
      failMsg.style.display = 'block'; tableWrap.style.display = 'none'; tbody.innerHTML = ''; return;
    }
    failMsg.style.display = 'none'; tableWrap.style.display = 'block';
    const regMap = loadRegisteredDevices();
    tbody.innerHTML = devices.map(dev => {
      const reg = !!regMap[dev.mac];
      const statusLabel = reg ? 'Registered' : 'New';
      const statusColor = reg ? '#08f76f' : '#9fc9db';
      const registeredInfo = reg ? regMap[dev.mac] : null;
      return `
        <tr>
          <td style="text-align:center;color:${statusColor};font-weight:700;padding:12px 8px;border-bottom:1px solid var(--line);">${statusLabel}</td>
          <td style="text-align:left;padding:12px 8px;border-bottom:1px solid var(--line);">${registeredInfo?.customName || dev.name || ''}</td>
          <td style="text-align:center;padding:12px 8px;font-family:monospace;border-bottom:1px solid var(--line);">${dev.ip || ''}</td>
          <td style="text-align:center;padding:12px 8px;font-family:monospace;border-bottom:1px solid var(--line);">${dev.mac || ''}</td>
          <td style="text-align:left;padding:12px 8px;border-bottom:1px solid var(--line);">${dev.vendor || ''}</td>
          <td style="text-align:center;padding:12px 8px;border-bottom:1px solid var(--line);">${dev.first_seen || ''}</td>
          <td style="text-align:center;padding:12px 8px;border-bottom:1px solid var(--line);">${dev.last_seen || ''}</td>
          <td style="text-align:center;padding:12px 8px;border-bottom:1px solid var(--line);">
            ${reg ? 
              `<button class="unregBtn" data-mac="${dev.mac}" style="padding:6px 10px;border-radius:8px;border:none;cursor:pointer;background:#666;color:var(--ink);font-weight:700;white-space:nowrap;">Unregister</button>` :
              `<button class="regBtn" data-mac="${dev.mac}" style="padding:6px 10px;border-radius:8px;border:none;cursor:pointer;background:var(--accent);color:#032c33;font-weight:700;white-space:nowrap;">Register</button>`
            }
          </td>
        </tr>
        ${registeredInfo?.notes ? `
        <tr>
          <td colspan="8" style="text-align:left;padding:12px 16px;background:rgba(0,229,255,.05);border-bottom:1px solid var(--line);">
            <div style="display:flex;align-items:center;gap:8px;">
              <strong style="color:var(--accent);">Notes:</strong>
              <span style="color:var(--muted);">${registeredInfo.notes}</span>
            </div>
          </td>
        </tr>
        ` : ''}
      `;
    }).join('');

    // attach handlers for registration buttons
    Array.from(document.getElementsByClassName('regBtn')).forEach(btn => {
      btn.onclick = () => {
        const mac = btn.getAttribute('data-mac');
        const idx = devices.findIndex(d => d.mac === mac);
        if (idx > -1) {
          document.getElementById('regDeviceMac').value = devices[idx].mac;
          document.getElementById('regDeviceName').value = devices[idx].name || '';
          document.getElementById('regDeviceNotes').value = '';
          document.getElementById('registerModal').style.display = 'block';
        }
      };
    });

    // attach handlers for unregister buttons
    Array.from(document.getElementsByClassName('unregBtn')).forEach(btn => {
      btn.onclick = () => {
        const mac = btn.getAttribute('data-mac');
        if (confirm('Are you sure you want to unregister this device?')) {
          unregisterDevice(mac);
          renderDevices(devices);
        }
      };
    });

    // handle registration form submission
    document.getElementById('registerForm').onsubmit = (e) => {
      e.preventDefault();
      const mac = document.getElementById('regDeviceMac').value;
      const customName = document.getElementById('regDeviceName').value;
      const notes = document.getElementById('regDeviceNotes').value;
      const idx = devices.findIndex(d => d.mac === mac);
      if (idx > -1) {
        registerDevice(devices[idx], customName, notes);
        document.getElementById('registerModal').style.display = 'none';
        renderDevices(devices);
      }
    };
  }

  // Auto-scan on load
  window.addEventListener('load', async ()=>{
    // run scan automatically
    const result = await runDeviceDiscovery();
    let devices = [];
    if (result && typeof result === 'string'){
      try { devices = JSON.parse(result); } catch { devices = []; }
    }
    // if no devices, fall back to example data
    if (!devices || !devices.length){
      // example fallback (kept minimal)
      devices = [
        { name:'Router', ip:'192.168.1.1', mac:'6C:DD:6C:B1:FF:02', vendor:'NetGear', first_seen:'2025-10-01', last_seen:'2025-10-22', status:'Healthy' },
        { name:'Laptop', ip:'192.168.1.11', mac:'4E:4C:29:F6:13:C2', vendor:'Dell', first_seen:'2025-09-30', last_seen:'2025-10-22', status:'Healthy' }
      ];
    }
    renderDevices(devices);
  });

  // Add scan button to the header
  const brandDiv = document.querySelector('.brand');
  const scanButton = document.createElement('button');
  scanButton.style.cssText = 'margin-left:16px;padding:8px 16px;border-radius:8px;background:var(--accent);color:#032c33;font-weight:700;border:none;cursor:pointer;';
  scanButton.textContent = 'Scan Network';
  scanButton.onclick = async () => {
    scanButton.disabled = true;
    scanButton.textContent = 'Scanning...';
    const result = await runDeviceDiscovery();
    let devices = [];
    if (result && typeof result === 'string') {
      try { devices = JSON.parse(result); } catch { devices = []; }
    }
    renderDevices(devices);
    scanButton.disabled = false;
    scanButton.textContent = 'Scan Network';
  };
  brandDiv.appendChild(scanButton);

  async function runDeviceDiscovery(){
    // Hit your Flask endpoint that runs "Device Discovery.py"
    try {
      if (scanOutput) scanOutput.textContent = "Running scan...";
      const r = await fetch(API_URL, { method:'GET', mode:'cors', cache:'no-store' });
      if(!r.ok){
        const txt = await r.text().catch(()=> '');
        throw new Error(`HTTP ${r.status} ${r.statusText}${txt ? ' ‚Äî ' + txt : ''}`);
      }
      const data = await r.json();
      let out = '';
      if (data && typeof data.stdout === 'string') out += data.stdout.trim();
      if (data && data.stderr && data.stderr.trim()) out += (out?'\n\n':'') + '[stderr]\n' + data.stderr.trim();
      // If backend returned structured JSON devices, prefer that
      if (data && data.devices) {
        pendingOutput = JSON.stringify(data.devices);
      } else {
        pendingOutput = out || "(no output)";
      }
    } catch (e) {
      pendingOutput = "Failed to contact server.\n" + e;
    }
    return pendingOutput;
  }

  function endMatrixTransitionAndShowOutput(){
    running = false;
    cancelAnimationFrame(rafId);
    stopLoadingPulse();
    overlay.style.display = 'none';
    switchToScan();
    scanOutput.textContent = pendingOutput;
  }

  // Click the logo: start transition, run Python, then reveal output
  enterScanBtn?.addEventListener('click', async () => {
    startTransition();
    let scanFailed = false;
    let resultText = '';
    let devices = [];
    try {
      await runDeviceDiscovery();
      if (pendingOutput.startsWith('Failed to contact server')) {
        scanFailed = true;
        resultText = 'Scan failed. No devices found.';
      } else {
        // Try to parse output as JSON array of devices, fallback to plain text
        try {
          devices = JSON.parse(pendingOutput);
        } catch {
          resultText = pendingOutput;
        }
      }
    } catch (e) {
      scanFailed = true;
      resultText = 'Scan failed. No devices found.';
    }
    showWord('SAFE', 900);
    setTimeout(() => {
      running = false;
      cancelAnimationFrame(rafId);
      stopLoadingPulse();
      overlay.style.display = 'none';
      switchToDevices();
      // Show/hide device table or error
      const failMsg = document.getElementById('scanFailMsg');
      const tableWrap = document.getElementById('devicesTableWrap');
      const tbody = document.getElementById('devicesBody');
      if (scanFailed || !devices || !Array.isArray(devices) || devices.length === 0) {
        failMsg.style.display = 'block';
        tableWrap.style.display = 'none';
        tbody.innerHTML = '';
      } else {
        failMsg.style.display = 'none';
        tableWrap.style.display = 'block';
        tbody.innerHTML = devices.map(dev => `
          <tr style="text-align:center;">
            <td style="text-align:center;">${dev.name || ''}</td>
            <td style="text-align:center;">${dev.ip || ''}</td>
            <td style="text-align:center;">${dev.mac || ''}</td>
            <td style="text-align:center;">${dev.type || ''}</td>
            <td style="text-align:center;"><span style="color:${dev.status === 'Healthy' ? '#08f76f' : '#9fc9db'}">${dev.status || ''}</span></td>
          </tr>
        `).join('');
      }
    }, 800);
  });

  window.addEventListener('resize', ()=>{ if(overlay.style.display==='block') sizeCanvas(); });

  // tiny toggle button
  function toggle(el){ el.textContent = el.textContent === 'On' ? 'Off' : 'On'; }
</script>
  <!-- ...existing code... -->
</body>
</html>
